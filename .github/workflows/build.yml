name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate JSON
        run: |
          python3 -c "
          import os, json, re, yaml

          POSTS_DIR = 'posts'
          OUTPUT_FILE = 'posts.json'
          posts = []

          if os.path.exists(POSTS_DIR):
              for f in os.listdir(POSTS_DIR):
                  if f.endswith('.md'):
                      filepath = os.path.join(POSTS_DIR, f)
                      
                      # 1. 基础信息
                      item = {
                          'file': f,
                          'title': f.replace('.md', ''),
                          'date': '2020-01-01',
                          'category': '默认',
                          'tags': [],
                          'word_count': 0  # 新增字数统计
                      }

                      # 2. 从文件名提取日期
                      match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                      if match:
                          item['date'] = match.group(1)
                          item['title'] = match.group(2)
                      
                      # 3. 读取内容并解析 Front Matter
                      try:
                          with open(filepath, 'r', encoding='utf-8') as file:
                              content = file.read()
                              
                              # 统计字数 (去掉空格和换行)
                              clean_text = re.sub(r'\s+', '', content)
                              item['word_count'] = len(clean_text)

                              # 解析 YAML
                              fm = re.search(r'^---\s*\n(.*?)\n---', content, re.DOTALL)
                              if fm:
                                  meta = yaml.safe_load(fm.group(1))
                                  if meta and isinstance(meta, dict):
                                      if 'title' in meta: item['title'] = str(meta['title'])
                                      if 'date' in meta: item['date'] = str(meta['date'])
                                      if 'category' in meta: item['category'] = str(meta['category'])
                                      if 'tags' in meta: item['tags'] = meta['tags'] if isinstance(meta['tags'], list) else [str(meta['tags'])]
                      except:
                          pass # 读取失败就用默认值

                      posts.append(item)

          # 按日期倒序
          posts.sort(key=lambda x: str(x['date']), reverse=True)

          with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
              json.dump(posts, f, ensure_ascii=False)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json
          git commit -m "Update posts & stats" || echo "No changes"
          git push
