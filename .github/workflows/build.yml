name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pyyaml

      # 1. ç”Ÿæˆ JSON æ•°æ® (å«æƒé‡é€»è¾‘)
      - name: Generate JSON
        run: |
          python3 -c "
          import os, json, re, yaml

          POSTS_DIR = 'posts'
          OUTPUT_FILE = 'posts.json'
          posts = []

          if os.path.exists(POSTS_DIR):
              for f in os.listdir(POSTS_DIR):
                  if f.endswith('.md'):
                      filepath = os.path.join(POSTS_DIR, f)
                      
                      item = {
                          'file': f,
                          'title': f.replace('.md', ''),
                          'date': '2020-01-01',
                          'category': 'é»˜è®¤',
                          'tags': [],
                          'word_count': 0,
                          'content': '',
                          'top': 0  # é»˜è®¤æƒé‡ä¸º 0
                      }

                      # æå–æ–‡ä»¶åé‡Œçš„æ—¥æœŸ
                      match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                      if match:
                          item['date'] = match.group(1)
                          item['title'] = match.group(2)
                      
                      try:
                          with open(filepath, 'r', encoding='utf-8') as file:
                              file_content = file.read()
                              
                              # ç»Ÿè®¡å­—æ•°
                              clean_text = re.sub(r'\s+', '', file_content)
                              item['word_count'] = len(clean_text)

                              # è§£æ Front Matter
                              fm = re.search(r'^---\s*\n(.*?)\n---', file_content, re.DOTALL)
                              if fm:
                                  meta = yaml.safe_load(fm.group(1))
                                  if meta and isinstance(meta, dict):
                                      if 'title' in meta: item['title'] = str(meta['title'])
                                      if 'date' in meta: item['date'] = str(meta['date'])
                                      if 'category' in meta: item['category'] = str(meta['category'])
                                      if 'tags' in meta: item['tags'] = meta['tags'] if isinstance(meta['tags'], list) else [str(meta['tags'])]
                                      # ğŸŸ¢ å…³é”®ï¼šè¯»å–æƒé‡
                                      if 'top' in meta: item['top'] = int(meta['top'])
                              
                              # è¯´è¯´å†…å®¹æå–
                              if item['category'] == 'è¯´è¯´':
                                  real_content = re.sub(r'^---\s*\n(.*?)\n---', '', file_content, flags=re.DOTALL).strip()
                                  item['content'] = real_content

                      except:
                          pass

                      posts.append(item)

          # ğŸŸ¢ ç»ˆææ’åºé€»è¾‘ï¼š
          # 1. å…ˆçœ‹ top æƒé‡ (å¤§çš„åœ¨ä¸Šé¢)
          # 2. æƒé‡ä¸€æ ·ï¼Œå†çœ‹ date æ—¥æœŸ (æ–°çš„åœ¨ä¸Šé¢)
          # 3. æ—¥æœŸä¸€æ ·ï¼Œå†çœ‹ file æ–‡ä»¶å (å€’åºï¼Œä¿è¯æ–°åˆ›å»ºçš„ md åœ¨ä¸Šé¢)
          posts.sort(key=lambda x: (x.get('top', 0), str(x['date']), x['file']), reverse=True)

          with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
              json.dump(posts, f, ensure_ascii=False)
          "

      # 2. æäº¤ä»£ç 
      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json
          git commit -m "Update posts with sorting" || echo "No changes"
          git push

      # 3. åˆ·æ–° Cloudflare ç¼“å­˜
      - name: Purge Cloudflare Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'
