name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate JSON
        run: |
          python3 -c "
          import os, json, re, yaml

          POSTS_DIR = 'posts'
          OUTPUT_FILE = 'posts.json'
          posts = []

          if os.path.exists(POSTS_DIR):
              for f in os.listdir(POSTS_DIR):
                  if f.endswith('.md'):
                      filepath = os.path.join(POSTS_DIR, f)
                      
                      item = {
                          'file': f,
                          'title': f.replace('.md', ''),
                          'date': '2020-01-01',
                          'category': '默认',
                          'tags': [],
                          'word_count': 0,
                          'content': '' # 默认为空，减少体积
                      }

                      # 提取日期
                      match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                      if match:
                          item['date'] = match.group(1)
                          item['title'] = match.group(2)
                      
                      try:
                          with open(filepath, 'r', encoding='utf-8') as file:
                              file_content = file.read()
                              
                              # 1. 统计字数
                              clean_text = re.sub(r'\s+', '', file_content)
                              item['word_count'] = len(clean_text)

                              # 2. 解析 Front Matter
                              fm = re.search(r'^---\s*\n(.*?)\n---', file_content, re.DOTALL)
                              if fm:
                                  meta = yaml.safe_load(fm.group(1))
                                  if meta and isinstance(meta, dict):
                                      if 'title' in meta: item['title'] = str(meta['title'])
                                      if 'date' in meta: item['date'] = str(meta['date'])
                                      if 'category' in meta: item['category'] = str(meta['category'])
                                      if 'tags' in meta: item['tags'] = meta['tags'] if isinstance(meta['tags'], list) else [str(meta['tags'])]
                              
                              # 3. 关键逻辑：如果是'说说'，则保存内容以便直接展示
                              if item['category'] == '说说':
                                  # 去除 Front Matter，只保留正文
                                  real_content = re.sub(r'^---\s*\n(.*?)\n---', '', file_content, flags=re.DOTALL).strip()
                                  item['content'] = real_content

                      except:
                          pass

                      posts.append(item)

          posts.sort(key=lambda x: str(x['date']), reverse=True)

          with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
              json.dump(posts, f, ensure_ascii=False)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json
          git commit -m "Update posts" || echo "No changes"
          git push
