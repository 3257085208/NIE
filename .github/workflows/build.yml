name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Generate JSON with Word Count
        run: |
          python3 -c "
          import os, json, re
          posts = []
          if os.path.exists('posts'):
              for f in os.listdir('posts'):
                  if f.endswith('.md'):
                      # 解析日期和标题
                      match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                      date = match.group(1) if match else 'Unknown'
                      title = match.group(2) if match else f.replace('.md', '')
                      
                      # 计算字数
                      with open(os.path.join('posts', f), 'r', encoding='utf-8') as file:
                          content = file.read()
                          word_count = len(content)
                      
                      posts.append({
                          'title': title, 
                          'date': date, 
                          'file': f, 
                          'words': word_count
                      })
          
          # 按日期排序
          posts.sort(key=lambda x: x['date'], reverse=True)
          
          with open('posts.json', 'w', encoding='utf-8') as out:
              json.dump(posts, out, ensure_ascii=False)
          print('JSON Generated')
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json
          git commit -m "Auto update posts.json" || echo "No changes to commit"
          git push
