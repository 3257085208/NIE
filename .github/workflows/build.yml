name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate JSON
        run: |
          python3 -c "
          import os, json, re, yaml

          posts = []
          # 扫描 posts 文件夹
          if os.path.exists('posts'):
              for f in os.listdir('posts'):
                  if f.endswith('.md'):
                      try:
                          item = {'file': f, 'title': f.replace('.md', ''), 'date': '2020-01-01', 'tags': []}
                          
                          # 1. 尝试从文件名获取日期
                          match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                          if match:
                              item['date'] = match.group(1)
                              item['title'] = match.group(2)
                          
                          # 2. 尝试读取 Front Matter (YAML头)
                          with open(os.path.join('posts', f), 'r', encoding='utf-8') as file:
                              content = file.read()
                              # 简单的正则匹配 YAML
                              fm = re.search(r'^---\s+(.*?)\s+---', content, re.DOTALL)
                              if fm:
                                  try:
                                      meta = yaml.safe_load(fm.group(1))
                                      if meta:
                                          if 'title' in meta: item['title'] = str(meta['title'])
                                          if 'date' in meta: item['date'] = str(meta['date'])
                                          if 'tags' in meta: item['tags'] = meta['tags']
                                  except: pass
                          
                          posts.append(item)
                      except: pass

          # 按日期倒序
          posts.sort(key=lambda x: x['date'], reverse=True)

          with open('posts.json', 'w', encoding='utf-8') as f:
              json.dump(posts, f, ensure_ascii=False)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json
          git commit -m "Auto update json" || echo "No changes"
          git push
