name: Auto Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate JSON and Inject to HTML
        run: |
          python3 -c "
          import os, json, re, yaml

          POSTS_DIR = 'posts'
          OUTPUT_FILE = 'posts.json'
          HTML_FILE = 'index.html'
          posts = []

          if os.path.exists(POSTS_DIR):
              for f in os.listdir(POSTS_DIR):
                  if f.endswith('.md'):
                      filepath = os.path.join(POSTS_DIR, f)
                      
                      item = {
                          'file': f,
                          'title': f.replace('.md', ''),
                          'date': '2020-01-01',
                          'category': 'ÈªòËÆ§',
                          'tags': [],
                          'word_count': 0,
                          'content': '',
                          'top': 0
                      }

                      match = re.match(r'(\d{4}-\d{2}-\d{2})-(.+)\.md', f)
                      if match:
                          item['date'] = match.group(1)
                          item['title'] = match.group(2)
                      
                      try:
                          with open(filepath, 'r', encoding='utf-8') as file:
                              file_content = file.read()
                              clean_text = re.sub(r'\s+', '', file_content)
                              item['word_count'] = len(clean_text)

                              fm = re.search(r'^---\s*\n(.*?)\n---', file_content, re.DOTALL)
                              if fm:
                                  meta = yaml.safe_load(fm.group(1))
                                  if meta and isinstance(meta, dict):
                                      if 'title' in meta: item['title'] = str(meta['title'])
                                      if 'date' in meta: item['date'] = str(meta['date'])
                                      if 'category' in meta: item['category'] = str(meta['category'])
                                      if 'tags' in meta: item['tags'] = meta['tags'] if isinstance(meta['tags'], list) else [str(meta['tags'])]
                                      if 'top' in meta: item['top'] = int(meta['top'])
                              
                              # ËØ¥ËØ¥ÂÜÖÂÆπÊèêÂèñ
                              if item['category'] == 'ËØ¥ËØ¥':
                                  real_content = re.sub(r'^---\s*\n(.*?)\n---', '', file_content, flags=re.DOTALL).strip()
                                  item['content'] = real_content

                      except:
                          pass

                      posts.append(item)

          # ÊéíÂ∫è
          posts.sort(key=lambda x: (x.get('top', 0), str(x['date']), x['file']), reverse=True)

          # 1. ‰øùÂ≠ò JSON (‰∏∫‰∫ÜÂ§á‰ªΩ)
          json_data = json.dumps(posts, ensure_ascii=False)
          with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
              f.write(json_data)

          # 2. üü¢ Ê†∏ÂøÉÔºöÊ≥®ÂÖ•Âà∞ HTML
          with open(HTML_FILE, 'r', encoding='utf-8') as f:
              html_content = f.read()
          
          # ÊõøÊç¢ÊöóÂè∑
          new_html = html_content.replace('const PRELOADED_DATA = null;', f'const PRELOADED_DATA = {json_data};')
          
          with open(HTML_FILE, 'w', encoding='utf-8') as f:
              f.write(new_html)
          "

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add posts.json index.html
          git commit -m "Build: Inject posts data to HTML" || echo "No changes"
          git push

      - name: Purge Cloudflare Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'
